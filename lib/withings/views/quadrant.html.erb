<%= render 'plugins/chart_js' %>
<script src="https://code.highcharts.com/modules/pattern-fill.js"></script>

<div class="view view--quadrant">
  <div class="layout layout--col">
    <div class="grid grid--cols-2">
      <% if local_assigns[:metrics].present? %>
        <div class="item">
          <div class="meta"></div>
          <div class="content">
            <span class="value value--tnums"><%= current_weight %></span>
            <span class="label">Current Weight</span>
          </div>
        </div>

        <div class="item">
          <div class="meta"></div>
          <div class="content">
            <% this_period_change = (metrics.last.values.first - metrics.first.values.first).round(1) %>
            <span class="value value--tnums"><%= this_period_change.positive? ? '+' : '-' %><%= this_period_change.abs %></span>
            <span class="label">This Period</span>
          </div>
        </div>
      <% end %>

      <% if local_assigns[:activity_metrics].present? && local_assigns[:activity_metrics].last.values.first[:steps].present? %>
        <% if goals.present? && goals['steps'] %>
          <div class="item">
            <div class="meta"></div>
            <div class="content">
              <span class="value value--tnums"><%= number_with_delimiter(goals['steps']) %></span>
              <span class="label">Daily Step Goal</span>
            </div>
          </div>
        <% end %>

        <div class="item">
          <div class="meta"></div>
          <div class="content">
            <span class="value value--tnums"><%= number_with_delimiter(local_assigns[:activity_metrics].last.values.first[:steps]) %></span>
            <span class="label">Last Measurement</span>
          </div>
        </div>
      <% end %>
    </div>

    <% if local_assigns[:metrics].present? %>
      <% formatted_data = metrics.map { |period| [l(Time.at(period.keys.first.to_s.to_i).to_date, format: :short, locale:), period.values.first] } %>
      <%= line_chart formatted_data, adapter: :highcharts, prefix: "", thousands: ",", points: false, colors: ["black"], curve: true,
                     library: {
                        chart: { height: 112 },
                        plotOptions: { series: { animation: false, lineWidth: 4 } },
                        yAxis: { min: metrics.map { it.values.first }.min - 2, labels: { style: { fontSize: '16px', color: '#000000' } }, gridLineDashStyle: 'shortdot', gridLineWidth: 1, gridLineColor: '#000000', tickAmount: 5 },
                        xAxis: { type: 'daytime', labels: { enabled: false }, lineWidth: 0, gridLineDashStyle: 'dot', tickWidth: 1, tickLength: 0, gridLineWidth: 1, gridLineColor: '#000000', tickPixelInterval: 120 }}
      %>
      <% elsif local_assigns[:activity_metrics].present? %>
        <% step_data = activity_metrics.map { |period| [l(period.keys.first.to_date, format: :short, locale:), period.values.first[:steps]] } %>
        <% formatted_data = [{ name: 'Steps', title: false, type: 'line', data: step_data, yAxis: 0, zIndex: 2, max: step_data.map { it[-1] }.max, labels: { style: { fontSize: '16px', color: '#000000' } }, gridLineDashStyle: 'shortdot', gridLineWidth: 1, gridLineColor: '#000000', tickAmount: 4 }] %>

        <% if local_assigns[:sleep_metrics].present? %>
          <% sleep_data = sleep_metrics.map { |period| [l(period.keys.first.to_date, format: :short, locale:), period.values.first[:total_sleep_time] / 3600.0] } %>
          <% formatted_data << { name: 'Sleep', title: false, type: 'column', data: sleep_data, yAxis: 1, zIndex: 1, max: sleep_data.map { it[-1] }.max, labels: { style: { fontSize: '16px', color: '#000000' } }, gridLineDashStyle: 'shortdot', gridLineWidth: 1, gridLineColor: '#000000', tickAmount: 4, opposite: true, color: { pattern: { image: 'https://usetrmnl.com/images/grayscale/gray-5.png', width: 12, height: 12 } } } %>
        <% end %>

        <%= line_chart formatted_data, adapter: :highcharts, prefix: "", thousands: ",", points: false, colors: ["black"], curve: true,
                       library: {
                         chart: { height: 112 },
                         plotOptions: { series: { animation: false, lineWidth: 4 } },
                         yAxis: formatted_data,
                         legend: false,
                         xAxis: { type: 'daytime', labels: { style: { fontSize: '16px', color: '#000000' } }, lineWidth: 0, gridLineDashStyle: 'dot', tickWidth: 1, tickLength: 0, gridLineWidth: 1, gridLineColor: '#000000', tickPixelInterval: 120 }}
        %>
      <% end %>
  </div>

  <%= render partial: 'plugins/withings/shared/title_bar', locals: { instance_name: instance_name } %>
</div>
